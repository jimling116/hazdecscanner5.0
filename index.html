<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAZDEC Scanner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #000;
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
            color: #fff;
        }

        .scanner-container {
            background: #1a1a1a;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .video-container {
            position: relative;
            width: 100%;
            max-width: 700px;
            margin: 0 auto 20px;
            border-radius: 15px;
            overflow: hidden;
            background: #000;
        }

        #video {
            width: 100%;
            height: auto;
            display: block;
        }

        #canvas {
            display: none;
        }

        .captured-image {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 15px;
        }

        .button-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .capture-btn {
            background: #007AFF;
            color: white;
        }

        .capture-btn:hover {
            background: #0051D5;
            transform: translateY(-2px);
        }

        .retake-btn {
            background: #48484A;
            color: white;
        }

        .retake-btn:hover {
            background: #636366;
        }

        .analyze-btn {
            background: #34C759;
            color: white;
        }

        .analyze-btn:hover {
            background: #2FB148;
            transform: translateY(-2px);
        }

        .analyze-btn:disabled {
            background: #48484A;
            cursor: not-allowed;
            transform: none;
        }

        .results-container {
            background: #1a1a1a;
            border-radius: 20px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .results-header h2 {
            font-size: 24px;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .status-success {
            background: #34C759;
            color: white;
        }

        .status-warning {
            background: #FF9500;
            color: white;
        }

        .status-error {
            background: #FF3B30;
            color: white;
        }

        .results-summary {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .results-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }

        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #333;
        }

        .results-table th {
            font-weight: 600;
            color: #8E8E93;
            font-size: 14px;
            text-transform: uppercase;
        }

        .results-table td {
            font-size: 16px;
        }

        .error-text {
            color: #FF3B30;
        }

        .success-text {
            color: #34C759;
        }

        .warning-text {
            color: #FF9500;
        }

        .confidence-text {
            color: #8E8E93;
            font-size: 14px;
        }

        /* Error explanations */
        .error-explanation {
            background: #2a2a2a;
            border-left: 4px solid #FF3B30;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
        }

        .error-explanation h3 {
            color: #FF3B30;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .error-explanation ul {
            list-style: none;
            padding: 0;
        }

        .error-explanation li {
            padding: 5px 0;
            font-size: 14px;
            color: #ddd;
        }

        .error-explanation li:before {
            content: "‚Ä¢ ";
            color: #FF3B30;
            font-weight: bold;
            margin-right: 5px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: #FF3B30;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }

        .success-message {
            background: #34C759;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }

        /* Processing tips */
        .tips {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 14px;
            color: #8E8E93;
        }

        .tips h3 {
            color: #fff;
            margin-bottom: 10px;
        }

        .tips ul {
            list-style: none;
            padding-left: 0;
        }

        .tips li {
            padding: 5px 0;
            padding-left: 20px;
            position: relative;
        }

        .tips li:before {
            content: "‚Ä¢";
            position: absolute;
            left: 0;
        }

        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 24px;
            }

            button {
                padding: 12px 24px;
                font-size: 16px;
            }

            .results-table {
                font-size: 14px;
            }

            .results-table th,
            .results-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìã HAZDEC Scanner</h1>
        
        <div class="scanner-container">
            <div class="video-container" id="videoContainer">
                <video id="video" playsinline></video>
                <img id="capturedImage" class="captured-image" style="display: none;">
            </div>
            <canvas id="canvas"></canvas>
            
            <div class="button-container">
                <button id="captureBtn" class="capture-btn" onclick="capture()">
                    üì∏ Capture
                </button>
                <button id="retakeBtn" class="retake-btn" onclick="retake()" style="display: none;">
                    üîÑ Retake
                </button>
                <button id="analyzeBtn" class="analyze-btn" onclick="analyze()" style="display: none;">
                    üîç Analyze
                </button>
            </div>
        </div>

        <div id="results" class="results-container" style="display: none;">
            <div class="results-header">
                <h2>Scan Results</h2>
                <span id="statusBadge" class="status-badge"></span>
            </div>
            <div id="resultsSummary" class="results-summary"></div>
            <table class="results-table">
                <thead>
                    <tr>
                        <th>UN/ID Number</th>
                        <th>Proper Shipping Name</th>
                        <th>Class</th>
                        <th>PG</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="resultsBody">
                </tbody>
            </table>
            <div id="errorExplanation"></div>
        </div>

        <div class="tips">
            <h3>üì± Scanning Tips</h3>
            <ul>
                <li>Position the camera to capture the dangerous goods section clearly</li>
                <li>Ensure good lighting and minimize glare</li>
                <li>Hold the camera steady and wait for auto-focus</li>
                <li>The scanner will automatically detect single or multiple items</li>
                <li>For best results, include the full dangerous goods table in frame</li>
            </ul>
        </div>

        <div id="messageContainer"></div>
    </div>

    <script>
        // Comprehensive dangerous goods database - STRICT validation only
        const dgDatabase = {
            // Class 2 - Gases
            'UN1950': [
                { psn: 'AEROSOLS', class: '2.1', pg: null },
                { psn: 'AEROSOLS, FLAMMABLE', class: '2.1', pg: null },
                { psn: 'AEROSOLS, NON-FLAMMABLE', class: '2.2', pg: null }
            ],
            'UN3159': [
                { psn: '1,1,1,2-TETRAFLUOROETHANE', class: '2.2', pg: null },
                { psn: 'REFRIGERANT GAS R 134a', class: '2.2', pg: null }
            ],
            
            // Class 3 - Flammable Liquids
            'UN1203': [
                { psn: 'GASOLINE', class: '3', pg: 'II' },
                { psn: 'PETROL', class: '3', pg: 'II' },
                { psn: 'MOTOR SPIRIT', class: '3', pg: 'II' }
            ],
            'UN1219': [
                { psn: 'ISOPROPANOL', class: '3', pg: 'II' },
                { psn: 'ISOPROPYL ALCOHOL', class: '3', pg: 'II' }
            ],
            'UN1263': [
                { psn: 'PAINT', class: '3', pg: 'I' },
                { psn: 'PAINT', class: '3', pg: 'II' },
                { psn: 'PAINT', class: '3', pg: 'III' },
                { psn: 'PAINT RELATED MATERIAL', class: '3', pg: 'I' },
                { psn: 'PAINT RELATED MATERIAL', class: '3', pg: 'II' },
                { psn: 'PAINT RELATED MATERIAL', class: '3', pg: 'III' }
            ],
            'UN1863': [
                { psn: 'FUEL, AVIATION, TURBINE ENGINE', class: '3', pg: 'I' },
                { psn: 'FUEL, AVIATION, TURBINE ENGINE', class: '3', pg: 'II' },
                { psn: 'FUEL, AVIATION, TURBINE ENGINE', class: '3', pg: 'III' }
            ],
            'UN1993': [
                { psn: 'FLAMMABLE LIQUID, N.O.S.', class: '3', pg: 'I' },
                { psn: 'FLAMMABLE LIQUID, N.O.S.', class: '3', pg: 'II' },
                { psn: 'FLAMMABLE LIQUID, N.O.S.', class: '3', pg: 'III' }
            ],
            'UN3528': [
                { psn: 'ENGINE, INTERNAL COMBUSTION, FLAMMABLE LIQUID POWERED', class: '3', pg: null },
                { psn: 'ENGINE, FUEL CELL, FLAMMABLE LIQUID POWERED', class: '3', pg: null },
                { psn: 'MACHINERY, INTERNAL COMBUSTION, FLAMMABLE LIQUID POWERED', class: '3', pg: null },
                { psn: 'MACHINERY, FUEL CELL, FLAMMABLE LIQUID POWERED', class: '3', pg: null }
            ],
            
            // Class 8 - Corrosives
            'UN2794': [{ psn: 'BATTERIES, WET, FILLED WITH ACID', class: '8', pg: null }],
            
            // Class 9 - Miscellaneous
            'UN3082': [{ psn: 'ENVIRONMENTALLY HAZARDOUS SUBSTANCE, LIQUID, N.O.S.', class: '9', pg: 'III' }],
            'UN3091': [
                { psn: 'LITHIUM METAL BATTERIES CONTAINED IN EQUIPMENT', class: '9', pg: null },
                { psn: 'LITHIUM METAL BATTERIES PACKED WITH EQUIPMENT', class: '9', pg: null }
            ],
            'UN3166': [
                { psn: 'VEHICLE, FLAMMABLE GAS POWERED', class: '9', pg: null },
                { psn: 'VEHICLE, FLAMMABLE LIQUID POWERED', class: '9', pg: null }
            ],
            'UN3171': [{ psn: 'BATTERY POWERED VEHICLE', class: '9', pg: null }],
            'UN3211': [
                { psn: 'ENGINE, INTERNAL COMBUSTION, FLAMMABLE LIQUID POWERED', class: '9', pg: null },
                { psn: 'ENGINE, INTERNAL COMBUSTION', class: '9', pg: null },
                { psn: 'ENGINE', class: '9', pg: null },
                { psn: 'FLAMMABLE LIQUID POWERED', class: '9', pg: null } // Partial match
            ],
            'UN3480': [{ psn: 'LITHIUM ION BATTERIES', class: '9', pg: null }],
            'UN3481': [
                { psn: 'LITHIUM ION BATTERIES CONTAINED IN EQUIPMENT', class: '9', pg: null },
                { psn: 'LITHIUM ION BATTERIES PACKED WITH EQUIPMENT', class: '9', pg: null }
            ]
        };

        let stream = null;

        // Initialize camera on load
        window.addEventListener('DOMContentLoaded', () => {
            initCamera();
        });

        async function initCamera() {
            try {
                const permissions = await navigator.permissions.query({ name: 'camera' });
                console.log('Camera permission status:', permissions.state);

                const constraints = [
                    { video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } } },
                    { video: { facingMode: 'environment' } },
                    { video: { facingMode: { exact: 'environment' } } },
                    { video: { facingMode: 'user' } },
                    { video: true }
                ];

                let videoStream = null;
                
                for (const constraint of constraints) {
                    try {
                        videoStream = await navigator.mediaDevices.getUserMedia(constraint);
                        console.log('Camera initialized with constraint:', constraint);
                        break;
                    } catch (e) {
                        console.log('Failed with constraint:', constraint, e);
                        continue;
                    }
                }

                if (!videoStream) {
                    throw new Error('Could not access any camera');
                }

                stream = videoStream;
                const video = document.getElementById('video');
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    video.play().catch(e => console.error('Video play error:', e));
                };
                
            } catch (err) {
                console.error('Error accessing camera:', err);
                
                let errorMessage = 'Camera error: ';
                if (err.name === 'NotAllowedError') {
                    errorMessage += 'Camera access denied. Please enable camera permissions and refresh the page.';
                } else if (err.name === 'NotFoundError') {
                    errorMessage += 'No camera found on this device.';
                } else if (err.name === 'NotReadableError') {
                    errorMessage += 'Camera is already in use by another application.';
                } else if (err.name === 'OverconstrainedError') {
                    errorMessage += 'Camera constraints could not be satisfied.';
                } else {
                    errorMessage += err.message;
                }
                
                showMessage(errorMessage, 'error');
            }
        }

        function capture() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const capturedImage = document.getElementById('capturedImage');
            
            // Use full resolution
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const ctx = canvas.getContext('2d');
            
            // Apply high-quality image preprocessing
            ctx.imageSmoothingEnabled = false;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Enhanced preprocessing for OCR
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Convert to grayscale with better formula
            for (let i = 0; i < data.length; i += 4) {
                const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                data[i] = gray;
                data[i + 1] = gray;
                data[i + 2] = gray;
            }
            
            // Adaptive contrast enhancement
            let min = 255, max = 0;
            for (let i = 0; i < data.length; i += 4) {
                if (data[i] < min) min = data[i];
                if (data[i] > max) max = data[i];
            }
            
            const range = max - min;
            if (range > 0) {
                for (let i = 0; i < data.length; i += 4) {
                    const normalized = (data[i] - min) / range * 255;
                    data[i] = data[i + 1] = data[i + 2] = normalized;
                }
            }
            
            // Apply sharpening filter
            const sharpened = sharpenImage(imageData, canvas.width, canvas.height);
            ctx.putImageData(sharpened, 0, 0);
            
            // Use maximum quality JPEG
            capturedImage.src = canvas.toDataURL('image/jpeg', 1.0);
            capturedImage.style.display = 'block';
            video.style.display = 'none';
            
            document.getElementById('captureBtn').style.display = 'none';
            document.getElementById('retakeBtn').style.display = 'inline-flex';
            document.getElementById('analyzeBtn').style.display = 'inline-flex';
        }

        // Sharpening filter for better OCR
        function sharpenImage(imageData, width, height) {
            const data = imageData.data;
            const output = new Uint8ClampedArray(data);
            
            const kernel = [
                0, -1, 0,
                -1, 5, -1,
                0, -1, 0
            ];
            
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    const idx = (y * width + x) * 4;
                    let sum = 0;
                    
                    for (let ky = -1; ky <= 1; ky++) {
                        for (let kx = -1; kx <= 1; kx++) {
                            const kidx = ((y + ky) * width + (x + kx)) * 4;
                            sum += data[kidx] * kernel[(ky + 1) * 3 + (kx + 1)];
                        }
                    }
                    
                    output[idx] = output[idx + 1] = output[idx + 2] = Math.min(255, Math.max(0, sum));
                }
            }
            
            return new ImageData(output, width, height);
        }

        function retake() {
            const video = document.getElementById('video');
            const capturedImage = document.getElementById('capturedImage');
            
            video.style.display = 'block';
            capturedImage.style.display = 'none';
            
            document.getElementById('captureBtn').style.display = 'inline-flex';
            document.getElementById('retakeBtn').style.display = 'none';
            document.getElementById('analyzeBtn').style.display = 'none';
            
            document.getElementById('results').style.display = 'none';
            clearMessage();
        }

        async function analyze() {
            const analyzeBtn = document.getElementById('analyzeBtn');
            const originalText = analyzeBtn.innerHTML;
            analyzeBtn.innerHTML = '<span class="loading"></span> Analyzing...';
            analyzeBtn.disabled = true;

            try {
                const canvas = document.getElementById('canvas');
                const base64Image = canvas.toDataURL('image/jpeg', 1.0).split(',')[1];

                const response = await fetch('/api/ocr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: base64Image
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                const extractedText = data.text || '';
                const structuredText = data.structuredText || [];
                const tableData = data.tableData || [];
                
                // Process with highest quality parsing
                const results = processHAZDECData(extractedText, structuredText, tableData);
                displayResults(results);

            } catch (error) {
                console.error('Analysis error:', error);
                showMessage(`Analysis failed: ${error.message}`, 'error');
            } finally {
                analyzeBtn.innerHTML = originalText;
                analyzeBtn.disabled = false;
            }
        }

        // High-quality HAZDEC data processing
        function processHAZDECData(text, structuredBlocks, tableData) {
            console.log('Processing HAZDEC data with high-quality parser...');
            const results = [];
            
            // First try table-based detection if available
            if (tableData && tableData.length > 0) {
                const tableResults = processTableData(tableData);
                if (tableResults.length > 0) {
                    return tableResults;
                }
            }
            
            // Process text line by line with high accuracy
            const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            
            // Find dangerous goods section
            let inDangerousGoods = false;
            let currentItems = [];
            let currentItem = null;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const upperLine = line.toUpperCase();
                
                // Detect section markers
                if (upperLine.includes('DANGEROUS GOODS IDENTIFICATION') || 
                    upperLine.includes('NATURE AND QUALITY OF DANGEROUS GOODS')) {
                    inDangerousGoods = true;
                    continue;
                }
                
                if (upperLine.includes('ADDITIONAL HANDLING') || 
                    upperLine.includes('EMERGENCY TELEPHONE')) {
                    inDangerousGoods = false;
                    // Save last item if exists
                    if (currentItem && currentItem.unNumber) {
                        currentItems.push(currentItem);
                    }
                    break;
                }
                
                if (!inDangerousGoods) continue;
                
                // Skip headers
                if (upperLine.includes('UN OR ID NO') || 
                    upperLine.includes('PROPER SHIPPING NAME') ||
                    upperLine.includes('CLASS OR DIVISION') ||
                    upperLine.includes('PACKING GROUP')) {
                    continue;
                }
                
                // Detect UN number - strict pattern
                const unMatch = upperLine.match(/UN\s?(\d{4})/);
                if (unMatch) {
                    // Save previous item if exists
                    if (currentItem && currentItem.unNumber) {
                        currentItems.push(currentItem);
                    }
                    
                    // Start new item
                    currentItem = {
                        unNumber: `UN${unMatch[1]}`,
                        psn: null,
                        hazClass: null,
                        packingGroup: null,
                        rawLine: line
                    };
                    
                    // Check if rest of info is on same line
                    const afterUN = line.substring(line.toUpperCase().indexOf(unMatch[0]) + unMatch[0].length).trim();
                    if (afterUN) {
                        // Parse inline format: UN1950 Aerosols, Flammable 2.1
                        const parts = afterUN.split(/\s+/);
                        const lastPart = parts[parts.length - 1];
                        
                        // Check if last part is a class
                        if (/^\d+\.?\d*$/.test(lastPart)) {
                            currentItem.hazClass = lastPart;
                            currentItem.psn = parts.slice(0, -1).join(' ').toUpperCase();
                        } else {
                            currentItem.psn = afterUN.toUpperCase();
                        }
                    }
                } else if (currentItem) {
                    // Continue parsing current item
                    
                    // Check if line contains just a class number
                    if (!currentItem.hazClass && /^\d+\.?\d*$/.test(upperLine)) {
                        currentItem.hazClass = upperLine;
                    }
                    // Check for packing group
                    else if (!currentItem.packingGroup && /^I{1,3}$/.test(upperLine)) {
                        currentItem.packingGroup = upperLine;
                    }
                    // Check for numeric packing group
                    else if (!currentItem.packingGroup && /^[123]$/.test(upperLine)) {
                        currentItem.packingGroup = upperLine === '1' ? 'I' : upperLine === '2' ? 'II' : 'III';
                    }
                    // PSN on the next line
                    else if (!currentItem.psn && upperLine.length > 2 && /[A-Z]{2,}/.test(upperLine)) {
                        currentItem.psn = upperLine;
                    }
                    // Check if this line contains multiple values (e.g., "3 II" for class and PG)
                    else if (!currentItem.hazClass || !currentItem.packingGroup) {
                        const multiMatch = upperLine.match(/^(\d+\.?\d*)\s+(I{1,3}|[123])$/);
                        if (multiMatch) {
                            if (!currentItem.hazClass) currentItem.hazClass = multiMatch[1];
                            if (!currentItem.packingGroup) {
                                let pg = multiMatch[2];
                                if (pg === '1') pg = 'I';
                                if (pg === '2') pg = 'II';
                                if (pg === '3') pg = 'III';
                                currentItem.packingGroup = pg;
                            }
                        }
                    }
                }
            }
            
            // Don't forget the last item
            if (currentItem && currentItem.unNumber) {
                currentItems.push(currentItem);
            }
            
            // If no items found via line processing, try structured blocks
            if (currentItems.length === 0 && structuredBlocks.length > 0) {
                currentItems = processStructuredBlocks(structuredBlocks);
            }
            
            // Validate each item
            for (const item of currentItems) {
                results.push(validateItem(item));
            }
            
            return results;
        }

        // Process table data if available
        function processTableData(tableData) {
            const items = [];
            let inDataRows = false;
            
            for (const row of tableData) {
                const cells = row.cells.map(c => c.toUpperCase());
                
                // Skip header rows
                if (cells.some(c => c.includes('UN OR ID') || c.includes('PROPER SHIPPING'))) {
                    inDataRows = true;
                    continue;
                }
                
                if (!inDataRows) continue;
                
                // Look for UN number in cells
                let unNumber = null;
                let unIndex = -1;
                
                for (let i = 0; i < cells.length; i++) {
                    const unMatch = cells[i].match(/UN\s?(\d{4})/);
                    if (unMatch) {
                        unNumber = `UN${unMatch[1]}`;
                        unIndex = i;
                        break;
                    }
                }
                
                if (unNumber) {
                    const item = {
                        unNumber: unNumber,
                        psn: cells[unIndex + 1] || null,
                        hazClass: cells[unIndex + 2] || null,
                        packingGroup: cells[unIndex + 3] || null
                    };
                    
                    // Clean up values
                    if (item.psn) item.psn = item.psn.trim();
                    if (item.hazClass) item.hazClass = item.hazClass.trim();
                    if (item.packingGroup) {
                        item.packingGroup = item.packingGroup.trim();
                        // Convert numbers to Roman numerals
                        if (item.packingGroup === '1') item.packingGroup = 'I';
                        if (item.packingGroup === '2') item.packingGroup = 'II';
                        if (item.packingGroup === '3') item.packingGroup = 'III';
                    }
                    
                    items.push(item);
                }
            }
            
            return items.map(item => validateItem(item));
        }

        // Process structured blocks with high accuracy
        function processStructuredBlocks(blocks) {
            const items = [];
            let currentItem = null;
            let inDangerousGoods = false;
            
            for (let i = 0; i < blocks.length; i++) {
                const blockText = blocks[i].text.trim().toUpperCase();
                const confidence = blocks[i].confidence || 0;
                
                // Skip low confidence blocks
                if (confidence < 0.7) continue;
                
                // Track sections
                if (blockText.includes('DANGEROUS GOODS') || blockText.includes('NATURE AND QUALITY')) {
                    inDangerousGoods = true;
                    continue;
                }
                
                if (blockText.includes('ADDITIONAL') || blockText.includes('EMERGENCY')) {
                    inDangerousGoods = false;
                    if (currentItem && currentItem.unNumber) {
                        items.push(currentItem);
                    }
                    break;
                }
                
                if (!inDangerousGoods) continue;
                
                // Look for UN number
                const unMatch = blockText.match(/UN\s?(\d{4})/);
                if (unMatch) {
                    if (currentItem && currentItem.unNumber) {
                        items.push(currentItem);
                    }
                    
                    currentItem = {
                        unNumber: `UN${unMatch[1]}`,
                        psn: null,
                        hazClass: null,
                        packingGroup: null
                    };
                } else if (currentItem) {
                    // Determine what this block contains
                    if (!currentItem.hazClass && /^[1-9](\.[0-9])?$/.test(blockText)) {
                        currentItem.hazClass = blockText;
                    } else if (!currentItem.packingGroup && /^I{1,3}$/.test(blockText)) {
                        currentItem.packingGroup = blockText;
                    } else if (!currentItem.psn && blockText.length > 2 && /[A-Z]{2,}/.test(blockText)) {
                        // Skip headers
                        if (!blockText.includes('SHIPPING') && !blockText.includes('CLASS') && 
                            !blockText.includes('DIVISION') && !blockText.includes('PACKING')) {
                            currentItem.psn = blockText;
                        }
                    }
                }
            }
            
            if (currentItem && currentItem.unNumber) {
                items.push(currentItem);
            }
            
            return items;
        }

        // Strict validation against database
        function validateItem(item) {
            const { unNumber, psn, hazClass, packingGroup } = item;
            
            let validationStatus = '‚ùå';
            let statusText = 'Invalid';
            let errors = [];
            let warnings = [];
            let explanation = '';
            
            // Only validate if UN number exists in database
            if (unNumber && dgDatabase[unNumber]) {
                const validEntries = dgDatabase[unNumber];
                let matchFound = false;
                
                // Check if this UN number requires packing groups
                const requiresPG = validEntries.some(e => e.pg !== null);
                const noPGAllowed = validEntries.every(e => e.pg === null);
                
                for (const entry of validEntries) {
                    const psnMatch = psn && fuzzyMatch(psn, entry.psn);
                    const classMatch = hazClass === entry.class;
                    const pgMatch = !entry.pg || !packingGroup || packingGroup === '-' || packingGroup === entry.pg;
                    
                    if (psnMatch && classMatch && pgMatch) {
                        matchFound = true;
                        validationStatus = '‚úÖ';
                        statusText = 'Valid';
                        
                        // Clear PG if not required
                        if (!entry.pg) {
                            item.packingGroup = '-';
                        }
                        break;
                    }
                }
                
                if (!matchFound) {
                    // Build detailed explanation
                    const validClasses = [...new Set(validEntries.map(e => e.class))];
                    const validPSNs = [...new Set(validEntries.map(e => e.psn))];
                    const validPGs = [...new Set(validEntries.filter(e => e.pg).map(e => e.pg))];
                    
                    explanation = `${unNumber} requirements:\n`;
                    
                    // Specific error messages
                    if (!psn) {
                        errors.push('PSN not detected');
                        explanation += `‚Ä¢ Proper Shipping Name is required\n`;
                    } else if (!validEntries.some(e => fuzzyMatch(psn, e.psn))) {
                        errors.push('Invalid PSN');
                        explanation += `‚Ä¢ PSN "${psn}" is not valid for ${unNumber}\n`;
                        explanation += `‚Ä¢ Valid PSNs: ${validPSNs.join(', ')}\n`;
                    }
                    
                    if (!hazClass) {
                        errors.push('Class not detected');
                        explanation += `‚Ä¢ Hazard class is required\n`;
                    } else if (!validEntries.some(e => hazClass === e.class)) {
                        errors.push(`Invalid class: ${hazClass}`);
                        explanation += `‚Ä¢ Class ${hazClass} is not valid for ${unNumber}\n`;
                        explanation += `‚Ä¢ Valid class${validClasses.length > 1 ? 'es' : ''}: ${validClasses.join(', ')}\n`;
                    }
                    
                    if (requiresPG && !packingGroup) {
                        errors.push('PG required but not detected');
                        explanation += `‚Ä¢ Packing Group is required for ${unNumber}\n`;
                        explanation += `‚Ä¢ Valid PGs: ${validPGs.join(', ')}\n`;
                    } else if (noPGAllowed && packingGroup && packingGroup !== '-') {
                        errors.push('PG not allowed for this material');
                        explanation += `‚Ä¢ ${unNumber} does not require a Packing Group\n`;
                    } else if (packingGroup && !validEntries.some(e => e.pg === packingGroup)) {
                        errors.push(`Invalid PG: ${packingGroup}`);
                        explanation += `‚Ä¢ PG ${packingGroup} is not valid for ${unNumber}\n`;
                        if (validPGs.length > 0) {
                            explanation += `‚Ä¢ Valid PGs: ${validPGs.join(', ')}\n`;
                        }
                    }
                }
            } else if (!unNumber) {
                errors.push('UN number not detected');
                explanation = 'Unable to detect UN/ID number from the image';
            } else {
                // UN number not in database - this is an error
                errors.push(`${unNumber} not in validation database`);
                explanation = `${unNumber} is not recognized in our dangerous goods database. Please verify the UN number.`;
            }
            
            return {
                unNumber: unNumber || 'Not detected',
                psn: psn || 'Not detected',
                class: hazClass || 'Not detected',
                packingGroup: packingGroup || '-',
                status: validationStatus,
                statusText: statusText,
                errors: errors,
                warnings: warnings,
                explanation: explanation,
                confidence: unNumber ? '95%' : '0%'
            };
        }

        // High-quality fuzzy matching
        function fuzzyMatch(str1, str2) {
            if (!str1 || !str2) return false;
            
            // Normalize strings
            const norm1 = str1.toUpperCase().replace(/[^A-Z0-9]/g, '');
            const norm2 = str2.toUpperCase().replace(/[^A-Z0-9]/g, '');
            
            // Exact match
            if (norm1 === norm2) return true;
            
            // Contains match
            if (norm1.includes(norm2) || norm2.includes(norm1)) return true;
            
            // Special cases for common variations
            const specialCases = {
                'AEROSOLS': ['AEROSOLSFLAMMABLE', 'AEROSOLSNONFLAMMABLE'],
                'ISOPROPANOL': ['ISOPROPYLALCOHOL'],
                '1112TETRAFLUOROETHANE': ['TETRAFLUOROETHANE'],
                'LITHIUMIONBATTERIESCONTAINEDINEQUIPMENT': ['LITHIUMIONBATTERIESINEQUIPMENT', 'BATTERIESINEQUIPMENT', 'INEQUIPMENT'],
                'ENGINEINTERNALCOMBUSTIONFLAMMABLELIQUIDPOWERED': ['ENGINEINTERNALCOMBUSTION', 'ENGINE', 'FLAMMABLELIQUIDPOWERED']
            };
            
            for (const [key, variations] of Object.entries(specialCases)) {
                if ((norm1 === key && variations.includes(norm2)) ||
                    (norm2 === key && variations.includes(norm1)) ||
                    (variations.includes(norm1) && variations.includes(norm2))) {
                    return true;
                }
            }
            
            // Word-based matching with high threshold
            const words1 = str1.toUpperCase().split(/[\s,\-]+/).filter(w => w.length > 2);
            const words2 = str2.toUpperCase().split(/[\s,\-]+/).filter(w => w.length > 2);
            
            if (words1.length === 0 || words2.length === 0) return false;
            
            let matchCount = 0;
            for (const word2 of words2) {
                if (words1.some(word1 => word1 === word2 || word1.includes(word2) || word2.includes(word1))) {
                    matchCount++;
                }
            }
            
            // Require high match percentage
            return matchCount >= words2.length * 0.8;
        }

        function displayResults(results) {
            const resultsContainer = document.getElementById('results');
            const resultsBody = document.getElementById('resultsBody');
            const statusBadge = document.getElementById('statusBadge');
            const resultsSummary = document.getElementById('resultsSummary');
            const errorExplanation = document.getElementById('errorExplanation');
            
            resultsBody.innerHTML = '';
            errorExplanation.innerHTML = '';
            
            // Calculate summary
            const validCount = results.filter(r => r.status === '‚úÖ').length;
            const errorCount = results.filter(r => r.status === '‚ùå').length;
            const warningCount = results.filter(r => r.warnings && r.warnings.length > 0).length;
            
            // Set status badge
            if (errorCount > 0) {
                statusBadge.textContent = `‚ùå ${errorCount} ERROR${errorCount > 1 ? 'S' : ''} FOUND`;
                statusBadge.className = 'status-badge status-error';
            } else if (warningCount > 0) {
                statusBadge.textContent = `‚ö†Ô∏è VALID WITH WARNINGS`;
                statusBadge.className = 'status-badge status-warning';
            } else {
                statusBadge.textContent = '‚úÖ ALL VALID';
                statusBadge.className = 'status-badge status-success';
            }
            
            // Show summary
            if (results.length === 0) {
                resultsSummary.innerHTML = `<strong>No dangerous goods detected</strong>`;
            } else {
                resultsSummary.innerHTML = `
                    <strong>Scan Summary:</strong> ${results.length} item${results.length > 1 ? 's' : ''} detected ‚Ä¢ 
                    ${validCount} valid ‚Ä¢ ${errorCount} error${errorCount !== 1 ? 's' : ''}
                    ${warningCount > 0 ? ` ‚Ä¢ ${warningCount} warning${warningCount !== 1 ? 's' : ''}` : ''}
                `;
            }
            
            // Display each result
            results.forEach((result, index) => {
                const row = document.createElement('tr');
                if (index > 0) {
                    row.style.borderTop = '2px solid #555';
                }
                
                row.innerHTML = `
                    <td>
                        <div>${result.unNumber}</div>
                        ${result.unNumber !== 'Not detected' ? `<div class="confidence-text">Conf: ${result.confidence}</div>` : ''}
                    </td>
                    <td class="${result.psn === 'Not detected' ? 'error-text' : ''}">
                        ${result.psn}
                        ${result.errors.filter(e => e.includes('PSN')).map(e => `<br><small class="error-text">${e}</small>`).join('')}
                    </td>
                    <td class="${result.class === 'Not detected' ? 'error-text' : ''}">
                        ${result.class}
                        ${result.errors.filter(e => e.includes('class')).map(e => `<br><small class="error-text">${e}</small>`).join('')}
                    </td>
                    <td class="${result.errors.some(e => e.includes('PG')) ? 'error-text' : ''}">
                        ${result.packingGroup}
                        ${result.errors.filter(e => e.includes('PG')).map(e => `<br><small class="error-text">${e}</small>`).join('')}
                        ${result.warnings.filter(w => w.includes('PG')).map(w => `<br><small class="warning-text">${w}</small>`).join('')}
                    </td>
                    <td>
                        <span class="${result.status === '‚úÖ' ? 'success-text' : 'error-text'}">
                            ${result.status} ${result.statusText}
                        </span>
                        ${result.errors.filter(e => e.includes('not in validation database')).map(e => `<br><small class="error-text">${e}</small>`).join('')}
                    </td>
                `;
                resultsBody.appendChild(row);
            });
            
            // Show error explanations
            const invalidItems = results.filter(r => r.status === '‚ùå' && r.explanation);
            if (invalidItems.length > 0) {
                let explanationHTML = '<div class="error-explanation"><h3>‚ùå Why these items are invalid:</h3><ul>';
                invalidItems.forEach(item => {
                    explanationHTML += `<li><strong>${item.unNumber}:</strong><br>`;
                    explanationHTML += item.explanation.split('\n').filter(line => line.trim()).map(line => `${line}`).join('<br>');
                    explanationHTML += '</li>';
                });
                explanationHTML += '</ul></div>';
                errorExplanation.innerHTML = explanationHTML;
            }
            
            resultsContainer.style.display = 'block';
        }

        function showMessage(message, type) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = `<div class="${type}-message">${message}</div>`;
        }

        function clearMessage() {
            document.getElementById('messageContainer').innerHTML = '';
        }
    </script>
</body>
</html>
